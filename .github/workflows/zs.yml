name: C++ Build (Multi-OS Parallel)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      # ────────────────────────────────────────────────────────────────
      # Linux / Ubuntu dependencies (apt)
      # ────────────────────────────────────────────────────────────────
      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            clang \
            libboost-all-dev \
            libssl-dev \
            nlohmann-json3-dev
          

      # ────────────────────────────────────────────────────────────────
      # macOS dependencies (Homebrew only — no brew on Ubuntu)
      # ────────────────────────────────────────────────────────────────
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install \
            cmake \
            boost \
            openssl \
            nlohmann-json
          

      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: ${{ runner.workspace }}/vcpkg
          vcpkgGitCommitId: '5b1214315250939257ef5d62ecdcbca18cf4fb1c'

      - name: Install dependencies via vcpkg (Windows)
        if: runner.os == 'Windows'
        run: |
          cd ${{ runner.workspace }}/vcpkg
          .\vcpkg install boost openssl nlohmann-json --triplet x64-windows


      # ────────────────────────────────────────────────────────────────
      # CMake configure - platform-specific
      # ────────────────────────────────────────────────────────────────
      - name: Configure CMake (Windows)
        if: runner.os == 'Windows'
        run: |
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release `
                   -DCMAKE_TOOLCHAIN_FILE="${{ runner.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
                   -DVCPKG_TARGET_TRIPLET=x64-windows

      - name: Configure CMake
        if: runner.os == 'Linux'
        run: |
          rm -rf build || true
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DBoost_NO_BOOST_CMAKE=ON \
            -DBoost_USE_STATIC_LIBS=OFF \
            -DBoost_USE_MULTITHREADED=ON
      - name: Configure CMake (macOS)
        if: runner.os == 'macOS'
        run: |
          rm -rf build || true
          mkdir build
          cd build
          export CMAKE_PREFIX_PATH="/opt/homebrew"
          export CMAKE_IGNORE_PATH="/opt/homebrew/lib/cmake/Boost-1.90.0"
          cmake .. \
           -DCMAKE_BUILD_TYPE=Release \
           -DCMAKE_FIND_PACKAGE_PREFER_CONFIG=FALSE \
           -DBoost_NO_BOOST_CMAKE=ON \
           -DBOOST_ROOT=/opt/homebrew \
           -DBoost_ROOT=/opt/homebrew \
           -DBoost_DIR=""
      
      # ────────────────────────────────────────────────────────────────
      # Build (common for all platforms)
      # ────────────────────────────────────────────────────────────────
      - name: Build
        run: |
          cd build
          cmake --build . --config Release --parallel $(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4)

      # ────────────────────────────────────────────────────────────────
      # Upload artifact
      # ────────────────────────────────────────────────────────────────
      - name: Upload executable
        uses: actions/upload-artifact@v7
        with:
          name: auth-${{ runner.os }}-${{ runner.arch }}
          path: build/auth${{ runner.os == 'Windows' && '.exe' || '' }}
          if-no-files-found: error
